<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Trevocar</title>
    <style>
        :root {
            --verde-principal: #2E8B57;
            --verde-escuro: #1E6B47;
            --verde-claro: #4CAF50;
            --verde-suave: #E8F5E8;
            --cinza-claro: #f8f9fa;
            --cinza-medio: #e9ecef;
            --cinza-escuro: #343a40;
            --branco: #ffffff;
            --vermelho: #dc3545;
            --laranja: #fd7e14;
            --azul: #007bff;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--cinza-claro);
            color: var(--cinza-escuro);
            line-height: 1.6;
        }
        
        /* Navbar */
        .navbar {
            background: linear-gradient(135deg, var(--verde-principal), var(--verde-escuro));
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            color: var(--branco);
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-details {
            text-align: right;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .user-role {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .logout-btn {
            background-color: rgba(255,255,255,0.2);
            color: var(--branco);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 20px;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .logout-btn:hover {
            background-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        /* Container Principal */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* Header do Dashboard */
        .dashboard-header {
            background: var(--branco);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid var(--verde-principal);
        }
        
        .dashboard-title {
            color: var(--verde-principal);
            font-size: 32px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .dashboard-subtitle {
            color: var(--cinza-escuro);
            font-size: 18px;
            opacity: 0.8;
        }
        
        /* Cards de Estat√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--branco);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            border-top: 4px solid var(--verde-principal);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .stat-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: var(--verde-principal);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--cinza-escuro);
            font-size: 16px;
            font-weight: 500;
        }
        
        /* Se√ß√µes de Gest√£o */
        .management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .management-card {
            background: var(--branco);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--verde-suave);
        }
        
        .card-icon {
            font-size: 28px;
            color: var(--verde-principal);
        }
        
        .card-title {
            font-size: 22px;
            color: var(--verde-principal);
            font-weight: 600;
        }
        
        /* Bot√µes */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--verde-principal), var(--verde-claro));
            color: var(--branco);
        }
        
        .btn-secondary {
            background: var(--verde-suave);
            color: var(--verde-principal);
            border: 1px solid var(--verde-principal);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--laranja), #ff9800);
            color: var(--branco);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--vermelho), #c62828);
            color: var(--branco);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Listas de Dados */
        .data-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .data-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--cinza-medio);
            transition: background-color 0.3s;
        }
        
        .data-item:hover {
            background-color: var(--verde-suave);
        }
        
        .data-item:last-child {
            border-bottom: none;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 600;
            color: var(--cinza-escuro);
        }
        
        .item-details {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .item-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pendente {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-aceita {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-andamento {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-concluida {
            background-color: var(--verde-suave);
            color: var(--verde-principal);
        }
        
        .status-cancelada {
            background-color: #f8d7da;
            color: var(--vermelho);
        }

        .item-actions {
            display: flex;
            gap: 8px;
            margin-left: 15px;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .edit-btn {
            background: var(--verde-suave);
            color: var(--verde-principal);
        }

        .delete-btn {
            background: #f8d7da;
            color: var(--vermelho);
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .management-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                grid-template-columns: 1fr;
            }
            
            .navbar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }

            .item-actions {
                flex-direction: column;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--branco);
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: var(--vermelho);
        }

        .modal-title {
            color: var(--verde-principal);
            margin-bottom: 25px;
            text-align: center;
            font-size: 24px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--cinza-escuro);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--cinza-medio);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--verde-principal);
            outline: none;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--cinza-medio);
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--branco);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--cinza-escuro);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--verde-principal), var(--verde-claro));
            color: var(--branco);
            box-shadow: 0 2px 8px rgba(46, 139, 87, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo">
            <span>üèéÔ∏è</span>
            <span>Trevocar Admin</span>
        </div>
        <div class="user-info">
            <div class="user-details">
                <div class="user-name" id="user-name">Administrador</div>
                <div class="user-role" id="user-role">Administrador</div>
            </div>
            <a href="/logout-funcionarios" class="logout-btn">üö™ Sair</a>
        </div>
    </nav>

    <!-- Container Principal -->
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <span>üìä</span>
                Dashboard Administrativo
            </h1>
            <p class="dashboard-subtitle">Controle completo do sistema Trevocar</p>
        </div>

        <!-- Sistema de Abas -->
        <div class="tabs">
            <div class="tab active" onclick="mostrarAba('aba-dashboard')">üìä Dashboard</div>
            <div class="tab" onclick="mostrarAba('aba-viagens')">üöó Gest√£o de Viagens</div>
        </div>

        <!-- Aba Dashboard -->
        <div id="aba-dashboard" class="tab-content active">
            <!-- Estat√≠sticas em Tempo Real -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üöó</div>
                    <div class="stat-number" id="total-veiculos">0</div>
                    <div class="stat-label">Total de Ve√≠culos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-number" id="total-funcionarios">0</div>
                    <div class="stat-label">Funcion√°rios</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üè¢</div>
                    <div class="stat-number" id="total-filiais">0</div>
                    <div class="stat-label">Filiais</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-number" id="total-categorias">0</div>
                    <div class="stat-label">Categorias</div>
                </div>
            </div>

            <!-- Gest√£o de Ve√≠culos -->
            <div class="management-grid">
                <!-- Gest√£o de Ve√≠culos -->
                <div class="management-card">
                    <div class="card-header">
                        <div class="card-icon">üöô</div>
                        <h3 class="card-title">Gest√£o de Ve√≠culos</h3>
                    </div>
                    <div class="data-list" id="veiculos-list">
                        <div class="loading">Carregando ve√≠culos...</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="carregarVeiculos()">
                            üîÑ Atualizar
                        </button>
                        <button class="btn btn-secondary" onclick="abrirModalVeiculo()">
                            ‚ûï Novo Ve√≠culo
                        </button>
                    </div>
                </div>

                <!-- Gest√£o de Funcion√°rios -->
                <div class="management-card">
                    <div class="card-header">
                        <div class="card-icon">üë•</div>
                        <h3 class="card-title">Gest√£o de Funcion√°rios</h3>
                    </div>
                    <div class="data-list" id="funcionarios-list">
                        <div class="loading">Carregando funcion√°rios...</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="carregarFuncionarios()">
                            üîÑ Atualizar
                        </button>
                        <button class="btn btn-secondary" onclick="abrirModalFuncionario()">
                            ‚ûï Cadastrar
                        </button>
                    </div>
                </div>

                <!-- Gest√£o de Filiais -->
                <div class="management-card">
                    <div class="card-header">
                        <div class="card-icon">üè¢</div>
                        <h3 class="card-title">Gest√£o de Filiais</h3>
                    </div>
                    <div class="data-list" id="filiais-list">
                        <div class="loading">Carregando filiais...</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="carregarFiliais()">
                            üîÑ Atualizar
                        </button>
                        <button class="btn btn-secondary" onclick="abrirModalFilial()">
                            ‚ûï Nova Filial
                        </button>
                    </div>
                </div>

                <!-- Categorias de Ve√≠culos -->
                <div class="management-card">
                    <div class="card-header">
                        <div class="card-icon">üìã</div>
                        <h3 class="card-title">Categorias de Ve√≠culos</h3>
                    </div>
                    <div class="data-list" id="categorias-list">
                        <div class="loading">Carregando categorias...</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="carregarCategorias()">
                            üîÑ Atualizar
                        </button>
                        <button class="btn btn-secondary" onclick="abrirModalCategoria()">
                            ‚ûï Nova Categoria
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba Gest√£o de Viagens -->
        <div id="aba-viagens" class="tab-content">
            <div class="management-grid">
                <!-- Criar Nova Viagem -->
                <div class="management-card">
                    <div class="card-header">
                        <div class="card-icon">üöÄ</div>
                        <h3 class="card-title">Criar Nova Viagem</h3>
                    </div>
                    <form id="formNovaViagem">
                        <div class="form-group">
                            <label for="cliente_viagem">Cliente *</label>
                            <select id="cliente_viagem" name="id_cliente" required>
                                <option value="">Carregando clientes...</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="origem_viagem">Origem *</label>
                                <input type="text" id="origem_viagem" name="origem" required placeholder="Local de partida">
                            </div>
                            <div class="form-group">
                                <label for="destino_viagem">Destino *</label>
                                <input type="text" id="destino_viagem" name="destino" required placeholder="Local de destino">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="data_viagem">Data/Hora *</label>
                                <input type="datetime-local" id="data_viagem" name="data_viagem" required>
                            </div>
                            <div class="form-group">
                                <label for="valor_viagem">Valor (R$)</label>
                                <input type="number" id="valor_viagem" name="valor" step="0.01" placeholder="0.00" min="0">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="veiculo_viagem">Ve√≠culo Sugerido</label>
                            <select id="veiculo_viagem" name="veiculo_solicitado">
                                <option value="">Carregando ve√≠culos...</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="passageiros_viagem">Passageiros</label>
                                <input type="number" id="passageiros_viagem" name="passageiros" min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label for="motorista_viagem">Motorista Designado</label>
                                <select id="motorista_viagem" name="id_motorista">
                                    <option value="">Carregando motoristas...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="observacoes_viagem">Observa√ß√µes</label>
                            <textarea id="observacoes_viagem" name="observacoes" rows="3" placeholder="Informa√ß√µes adicionais..."></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="limparFormularioViagem()">Limpar</button>
                            <button type="submit" class="btn btn-primary">üöÄ Criar Viagem</button>
                        </div>
                    </form>
                </div>

                <!-- Viagens Pendentes -->
                <div class="management-card">
                    <div class="card-header">
                        <div class="card-icon">‚è≥</div>
                        <h3 class="card-title">Viagens Pendentes</h3>
                    </div>
                    <div class="data-list" id="viagens-pendentes-list">
                        <div class="loading">Carregando viagens pendentes...</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="carregarViagens()">
                            üîÑ Atualizar
                        </button>
                    </div>
                </div>


                <!-- Hist√≥rico de Viagens -->
                <div class="management-card">
                    <div class="card-header">
                        <div class="card-icon">üìä</div>
                        <h3 class="card-title">Hist√≥rico de Viagens</h3>
                    </div>
                    <div class="data-list" id="viagens-concluidas-list">
                        <div class="loading">Carregando hist√≥rico...</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="carregarViagens()">
                            üîÑ Atualizar
                        </button>
                        <button class="btn btn-secondary" onclick="exportarRelatorioViagens()">
                            üìÑ Exportar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Cadastrar Ve√≠culo -->
    <div id="modalVeiculo" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModalVeiculo()">&times;</span>
            <h2 class="modal-title">üöó Cadastrar Novo Ve√≠culo</h2>
            
            <form id="formVeiculo">
                <div class="form-group">
                    <label for="placa">Placa *</label>
                    <input type="text" id="placa" name="placa" required maxlength="8" placeholder="ABC1D23">
                </div>
                
                <div class="form-group">
                    <label for="modelo">Modelo *</label>
                    <input type="text" id="modelo" name="modelo" required placeholder="BYD Dolphin">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ano">Ano *</label>
                        <input type="number" id="ano" name="ano" required min="2000" max="2030" placeholder="2024">
                    </div>
                    
                    <div class="form-group">
                        <label for="cor">Cor *</label>
                        <input type="text" id="cor" name="cor" required placeholder="Branco">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="quilometragem">Quilometragem</label>
                    <input type="number" id="quilometragem" name="quilometragem" step="0.01" placeholder="0.00" value="0">
                </div>
                
                <div class="form-group">
                    <label for="id_categoria">Categoria *</label>
                    <select id="id_categoria" name="id_categoria" required>
                        <option value="">Carregando categorias...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="id_filial">Filial *</label>
                    <select id="id_filial" name="id_filial" required>
                        <option value="">Carregando filiais...</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalVeiculo()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Cadastrar Ve√≠culo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Editar Ve√≠culo -->
    <div id="modalEditarVeiculo" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModalEditarVeiculo()">&times;</span>
            <h2 class="modal-title">‚úèÔ∏è Editar Ve√≠culo</h2>
            
            <form id="formEditarVeiculo">
                <input type="hidden" id="editar_id_veiculo" name="id_veiculo">
                
                <div class="form-group">
                    <label for="editar_placa">Placa *</label>
                    <input type="text" id="editar_placa" name="placa" required maxlength="8">
                </div>
                
                <div class="form-group">
                    <label for="editar_modelo">Modelo *</label>
                    <input type="text" id="editar_modelo" name="modelo" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="editar_ano">Ano *</label>
                        <input type="number" id="editar_ano" name="ano" required min="2000" max="2030">
                    </div>
                    
                    <div class="form-group">
                        <label for="editar_cor">Cor *</label>
                        <input type="text" id="editar_cor" name="cor" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="editar_quilometragem">Quilometragem</label>
                    <input type="number" id="editar_quilometragem" name="quilometragem" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="editar_status">Status *</label>
                    <select id="editar_status" name="status" required>
                        <option value="dispon√≠vel">Dispon√≠vel</option>
                        <option value="alugado">Alugado</option>
                        <option value="em manuten√ß√£o">Em Manuten√ß√£o</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editar_id_categoria">Categoria *</label>
                    <select id="editar_id_categoria" name="id_categoria" required>
                        <option value="">Carregando categorias...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editar_id_filial">Filial *</label>
                    <select id="editar_id_filial" name="id_filial" required>
                        <option value="">Carregando filiais...</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="fecharModalEditarVeiculo()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </div>

       <script>
// ========== CONFIGURA√á√ïES GLOBAIS ==========
const CONFIG = {
    API_BASE_URL: '/api',
    DEMO_MODE: false,
    ENDPOINTS: {
        VIAGENS: ['/viagens', '/admin/viagens', '/viagens/todas'],
        CLIENTES: ['/clientes', '/admin/clientes'], 
        MOTORISTAS: ['/motoristas', '/admin/motoristas', '/funcionarios?cargo=motorista'],
        VEICULOS: ['/veiculos', '/veiculos-disponiveis']
    }
};

// ========== ESTADO DA APLICA√á√ÉO ==========
const appState = {
    viagens: [],
    veiculos: [],
    clientes: [],
    motoristas: [],
    categorias: [],
    filiais: [],
    funcionarios: [],
    endpointsAtivos: {}
};

// ========== INICIALIZA√á√ÉO ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('üèÅ Dashboard Admin inicializando...');
    
    // Configurar data/hora padr√£o para o formul√°rio de viagem
    const agora = new Date();
    agora.setHours(agora.getHours() + 1);
    document.getElementById('data_viagem').value = agora.toISOString().slice(0, 16);
    
    // Carregar dados iniciais
    inicializarDashboard();
    
    // Configurar event listeners
    configurarEventListeners();
});

// ========== FUN√á√ïES DE INICIALIZA√á√ÉO ==========
async function inicializarDashboard() {
    atualizarInterface();
    
    // Primeiro descobrir quais endpoints est√£o ativos
    await descobrirEndpointsAtivos();
    
    // Depois carregar os dados
    carregarEstatisticas();
    carregarVeiculos();
    carregarFuncionarios();
    carregarFiliais();
    carregarCategorias();
}

async function descobrirEndpointsAtivos() {
    console.log('üîç Descobrindo endpoints ativos...');
    
    const endpointsParaTestar = [
        ...CONFIG.ENDPOINTS.VIAGENS.map(e => ({ tipo: 'viagens', endpoint: e })),
        ...CONFIG.ENDPOINTS.CLIENTES.map(e => ({ tipo: 'clientes', endpoint: e })),
        ...CONFIG.ENDPOINTS.MOTORISTAS.map(e => ({ tipo: 'motoristas', endpoint: e })),
        ...CONFIG.ENDPOINTS.VEICULOS.map(e => ({ tipo: 'veiculos', endpoint: e }))
    ];

    for (const item of endpointsParaTestar) {
        try {
            const response = await fetch(`${CONFIG.API_BASE_URL}${item.endpoint}`);
            if (response.ok) {
                appState.endpointsAtivos[item.tipo] = item.endpoint;
                console.log(`‚úÖ Endpoint ativo: ${item.tipo} -> ${item.endpoint}`);
                break; // Usa o primeiro endpoint que funcionar para cada tipo
            }
        } catch (error) {
            // Continua para o pr√≥ximo endpoint
        }
    }
    
    console.log('üìã Endpoints ativos encontrados:', appState.endpointsAtivos);
}

function configurarEventListeners() {
    // Formul√°rios
    document.getElementById('formNovaViagem').addEventListener('submit', criarViagem);
    document.getElementById('formVeiculo').addEventListener('submit', cadastrarVeiculo);
    document.getElementById('formEditarVeiculo').addEventListener('submit', editarVeiculoSubmit);
    
    // Fechar modais ao clicar fora
    window.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
}

// ========== SISTEMA DE ABAS ==========
function mostrarAba(abaId) {
    // Esconder todas as abas
    document.querySelectorAll('.tab-content').forEach(aba => {
        aba.classList.remove('active');
    });
    
    // Remover active de todas as tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar aba selecionada
    document.getElementById(abaId).classList.add('active');
    
    // Ativar tab clicada
    event.target.classList.add('active');
    
    // Carregar dados espec√≠ficos da aba
    if (abaId === 'aba-viagens') {
        carregarDadosViagens();
    }
}

// ========== FUN√á√ïES DO DASHBOARD GERAL ==========

// Carregar estat√≠sticas
async function carregarEstatisticas() {
    try {
        console.log('üìä Carregando estat√≠sticas...');
        const response = await fetch(`${CONFIG.API_BASE_URL}/estatisticas`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            const stats = data.estatisticas;
            document.getElementById('total-veiculos').textContent = stats.total_veiculos || '0';
            document.getElementById('total-funcionarios').textContent = stats.total_funcionarios || '0';
            document.getElementById('total-filiais').textContent = stats.total_filiais || '0';
            document.getElementById('total-categorias').textContent = stats.total_categorias || '0';
        } else {
            throw new Error('Estat√≠sticas n√£o dispon√≠veis');
        }
    } catch (error) {
        console.error('Erro ao carregar estat√≠sticas:', error);
        document.getElementById('total-veiculos').textContent = '0';
        document.getElementById('total-funcionarios').textContent = '0';
        document.getElementById('total-filiais').textContent = '0';
        document.getElementById('total-categorias').textContent = '0';
    }
}

// Carregar ve√≠culos
async function carregarVeiculos() {
    try {
        console.log('üöó Carregando ve√≠culos...');
        const response = await fetch(`${CONFIG.API_BASE_URL}/veiculos`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const lista = document.getElementById('veiculos-list');
        
        if (data.success && data.veiculos) {
            appState.veiculos = data.veiculos;
            lista.innerHTML = data.veiculos.map(veiculo => `
                <div class="data-item">
                    <div class="item-info">
                        <div class="item-name">${veiculo.modelo} - ${veiculo.placa}</div>
                        <div class="item-details">
                            ${veiculo.ano} ‚Ä¢ ${veiculo.cor} ‚Ä¢ ${veiculo.quilometragem} km
                            ${veiculo.categoria_nome ? ` ‚Ä¢ ${veiculo.categoria_nome}` : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit-btn" onclick="editarVeiculo(${veiculo.id_veiculo})">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="action-btn delete-btn" onclick="excluirVeiculo(${veiculo.id_veiculo}, '${veiculo.placa}')">
                            üóëÔ∏è Excluir
                        </button>
                    </div>
                    <div class="item-status status-${veiculo.status === 'dispon√≠vel' ? 'available' : 'maintenance'}">
                        ${veiculo.status}
                    </div>
                </div>
            `).join('');
        } else {
            lista.innerHTML = `
                <div class="data-item">
                    <div class="item-info">
                        <div class="item-name">Nenhum ve√≠culo cadastrado</div>
                        <div class="item-details">Cadastre o primeiro ve√≠culo no sistema</div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao carregar ve√≠culos:', error);
        document.getElementById('veiculos-list').innerHTML = `
            <div class="data-item">
                <div class="item-info">
                    <div class="item-name">Erro ao carregar ve√≠culos</div>
                    <div class="item-details">Verifique a conex√£o com o servidor</div>
                </div>
            </div>
        `;
    }
}

// Carregar funcion√°rios
async function carregarFuncionarios() {
    try {
        console.log('üë• Carregando funcion√°rios...');
        const response = await fetch(`${CONFIG.API_BASE_URL}/funcionarios`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const lista = document.getElementById('funcionarios-list');
        
        if (data.success && data.funcionarios) {
            appState.funcionarios = data.funcionarios;
            lista.innerHTML = data.funcionarios.map(funcionario => `
                <div class="data-item">
                    <div class="item-info">
                        <div class="item-name">${funcionario.nome}</div>
                        <div class="item-details">
                            ${funcionario.email} ‚Ä¢ ${funcionario.cargo}
                        </div>
                    </div>
                    <div class="item-status ${funcionario.ativo ? 'status-available' : 'status-maintenance'}">
                        ${funcionario.ativo ? 'Ativo' : 'Inativo'}
                    </div>
                </div>
            `).join('');
        } else {
            lista.innerHTML = `
                <div class="data-item">
                    <div class="item-info">
                        <div class="item-name">Nenhum funcion√°rio cadastrado</div>
                        <div class="item-details">Cadastre funcion√°rios pelo sistema</div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao carregar funcion√°rios:', error);
        document.getElementById('funcionarios-list').innerHTML = `
            <div class="data-item">
                <div class="item-info">
                    <div class="item-name">Erro ao carregar funcion√°rios</div>
                    <div class="item-details">Verifique a conex√£o com o servidor</div>
                </div>
            </div>
        `;
    }
}

// Carregar filiais
async function carregarFiliais() {
    try {
        console.log('üè¢ Carregando filiais...');
        const response = await fetch(`${CONFIG.API_BASE_URL}/filiais`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const lista = document.getElementById('filiais-list');
        
        if (data.success && data.filiais) {
            appState.filiais = data.filiais;
            lista.innerHTML = data.filiais.map(filial => `
                <div class="data-item">
                    <div class="item-info">
                        <div class="item-name">${filial.nome}</div>
                        <div class="item-details">${filial.endereco}</div>
                    </div>
                </div>
            `).join('');
        } else {
            lista.innerHTML = `
                <div class="data-item">
                    <div class="item-info">
                        <div class="item-name">Nenhuma filial cadastrada</div>
                        <div class="item-details">Cadastre a primeira filial</div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao carregar filiais:', error);
        document.getElementById('filiais-list').innerHTML = `
            <div class="data-item">
                <div class="item-info">
                    <div class="item-name">Erro ao carregar filiais</div>
                    <div class="item-details">Verifique a conex√£o com o servidor</div>
                </div>
            </div>
        `;
    }
}

// Carregar categorias
async function carregarCategorias() {
    try {
        console.log('üìã Carregando categorias...');
        const response = await fetch(`${CONFIG.API_BASE_URL}/categorias`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const lista = document.getElementById('categorias-list');
        
        if (data.success && data.categorias) {
            appState.categorias = data.categorias;
            lista.innerHTML = data.categorias.map(categoria => `
                <div class="data-item">
                    <div class="item-info">
                        <div class="item-name">${categoria.nome}</div>
                        <div class="item-details">R$ ${parseFloat(categoria.preco_diaria || 0).toFixed(2)}/dia</div>
                    </div>
                </div>
            `).join('');
        } else {
            lista.innerHTML = `
                <div class="data-item">
                    <div class="item-info">
                        <div class="item-name">Nenhuma categoria cadastrada</div>
                        <div class="item-details">Cadastre categorias de ve√≠culos</div>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Erro ao carregar categorias:', error);
        document.getElementById('categorias-list').innerHTML = `
            <div class="data-item">
                <div class="item-info">
                    <div class="item-name">Erro ao carregar categorias</div>
                    <div class="item-details">Verifique a conex√£o com o servidor</div>
                </div>
            </div>
        `;
    }
}

// ========== FUN√á√ïES DA ABA DE VIAGENS ==========
async function carregarDadosViagens() {
    try {
        console.log('üöó Carregando dados para viagens...');
        
        await Promise.all([
            carregarClientes(),
            carregarVeiculosParaViagem(),
            carregarMotoristas(),
            carregarViagens()
        ]);
        
    } catch (error) {
        console.error('Erro ao carregar dados para viagens:', error);
        mostrarErroCarregamento();
    }
}

async function carregarClientes() {
    try {
        let endpoint = appState.endpointsAtivos.clientes || '/clientes';
        const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const selectCliente = document.getElementById('cliente_viagem');
        
        if (data.success && data.clientes) {
            appState.clientes = data.clientes;
            selectCliente.innerHTML = '<option value="">Selecione um cliente</option>' +
                data.clientes.map(cliente => 
                    `<option value="${cliente.id_cliente || cliente.id}">${cliente.nome} - ${cliente.email || 'Sem email'}</option>`
                ).join('');
        } else {
            selectCliente.innerHTML = '<option value="">Nenhum cliente dispon√≠vel</option>';
        }
    } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        document.getElementById('cliente_viagem').innerHTML = '<option value="">Erro ao carregar clientes</option>';
    }
}

async function carregarVeiculosParaViagem() {
    try {
        let endpoint = appState.endpointsAtivos.veiculos || '/veiculos';
        const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const selectVeiculo = document.getElementById('veiculo_viagem');
        
        if (data.success && data.veiculos) {
            selectVeiculo.innerHTML = '<option value="">Qualquer ve√≠culo dispon√≠vel</option>' +
                data.veiculos.map(veiculo => 
                    `<option value="${veiculo.modelo}">${veiculo.modelo} - ${veiculo.placa}</option>`
                ).join('');
        } else {
            selectVeiculo.innerHTML = '<option value="">Nenhum ve√≠culo dispon√≠vel</option>';
        }
    } catch (error) {
        console.error('Erro ao carregar ve√≠culos:', error);
        document.getElementById('veiculo_viagem').innerHTML = '<option value="">Erro ao carregar ve√≠culos</option>';
    }
}

async function carregarMotoristas() {
    try {
        let endpoint = appState.endpointsAtivos.motoristas;
        
        if (!endpoint) {
            // Se n√£o encontrou endpoint espec√≠fico, tentar filtrar funcion√°rios
            const response = await fetch(`${CONFIG.API_BASE_URL}/funcionarios`);
            if (response.ok) {
                const data = await response.json();
                const selectMotorista = document.getElementById('motorista_viagem');
                
                if (data.success && data.funcionarios) {
                    const motoristas = data.funcionarios.filter(f => 
                        f.cargo && f.cargo.toLowerCase().includes('motorista')
                    );
                    
                    appState.motoristas = motoristas;
                    selectMotorista.innerHTML = '<option value="">Atribuir automaticamente</option>' +
                        motoristas.map(motorista => 
                            `<option value="${motorista.id_funcionario || motorista.id}">${motorista.nome}</option>`
                        ).join('');
                    return;
                }
            }
            throw new Error('Nenhum endpoint de motoristas dispon√≠vel');
        }
        
        const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const selectMotorista = document.getElementById('motorista_viagem');
        
        if (data.success && data.motoristas) {
            appState.motoristas = data.motoristas;
            selectMotorista.innerHTML = '<option value="">Atribuir automaticamente</option>' +
                data.motoristas.map(motorista => 
                    `<option value="${motorista.id_funcionario || motorista.id}">${motorista.nome}</option>`
                ).join('');
        } else {
            selectMotorista.innerHTML = '<option value="">Nenhum motorista dispon√≠vel</option>';
        }
    } catch (error) {
        console.error('Erro ao carregar motoristas:', error);
        document.getElementById('motorista_viagem').innerHTML = '<option value="">Erro ao carregar motoristas</option>';
    }
}

async function carregarViagens() {
    try {
        let endpoint = appState.endpointsAtivos.viagens;
        
        if (!endpoint) {
            // Se n√£o encontrou endpoint, tentar criar viagem de teste para ver se a tabela existe
            console.log('‚ö†Ô∏è  Nenhum endpoint de viagens encontrado. Verificando se a tabela existe...');
            await testarCriacaoViagem();
            return;
        }
        
        console.log(`üîÑ Carregando viagens do endpoint: ${endpoint}`);
        const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Dados de viagens recebidos:', data);
        
        if (data.success && data.viagens) {
            appState.viagens = data.viagens;
            console.log(`‚úÖ ${data.viagens.length} viagens carregadas`);
            renderizarViagens(data.viagens);
        } else if (data.viagens) {
            appState.viagens = data.viagens;
            console.log(`‚úÖ ${data.viagens.length} viagens carregadas (estrutura alternativa)`);
            renderizarViagens(data.viagens);
        } else {
            console.log('‚ÑπÔ∏è Nenhuma viagem encontrada');
            renderizarViagens([]);
        }
    } catch (error) {
        console.error('Erro ao carregar viagens:', error);
        mostrarErroViagensEspecifico();
    }
}

// Fun√ß√£o para testar se podemos criar viagens (verifica se a tabela existe)
async function testarCriacaoViagem() {
    try {
        console.log('üß™ Testando cria√ß√£o de viagem...');
        
        // Dados de teste m√≠nimos
        const dadosTeste = {
            id_cliente: 1,
            origem: 'Teste',
            destino: 'Teste', 
            data_viagem: new Date().toISOString(),
            valor: 0,
            passageiros: 1,
            status: 'pendente'
        };
        
        const response = await fetch(`${CONFIG.API_BASE_URL}/viagens`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dadosTeste)
        });
        
        if (response.ok) {
            console.log('‚úÖ Tabela de viagens existe! Endpoint POST /api/viagens funciona.');
            // Agora tentar buscar as viagens novamente
            const responseGet = await fetch(`${CONFIG.API_BASE_URL}/viagens`);
            if (responseGet.ok) {
                const data = await responseGet.json();
                if (data.viagens) {
                    appState.viagens = data.viagens;
                    renderizarViagens(data.viagens);
                    appState.endpointsAtivos.viagens = '/viagens';
                    return;
                }
            }
        }
        
        throw new Error('N√£o foi poss√≠vel acessar a tabela de viagens');
        
    } catch (error) {
        console.error('‚ùå Teste de viagem falhou:', error);
        mostrarConfiguracaoViagens();
    }
}

function mostrarConfiguracaoViagens() {
    const elementos = ['viagens-pendentes-list', 'viagens-andamento-list', 'viagens-concluidas-list'];
    
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚öôÔ∏è</div>
                    <div>Sistema de Viagens</div>
                    <div style="font-size: 12px; margin-top: 5px; text-align: left; padding: 10px;">
                        <strong>Para usar o sistema de viagens:</strong><br>
                        1. Verifique se a tabela 'viagens' existe no MySQL<br>
                        2. Confirme os endpoints no app.py<br>
                        3. Recarregue a p√°gina<br>
                        <br>
                        <em>Endpoints testados:</em><br>
                        - /api/viagens (GET/POST)<br>
                        - /api/admin/viagens<br>
                        - /api/viagens/todas
                    </div>
                </div>
            `;
        }
    });
}

function renderizarViagens(viagens) {
    console.log('üé® Renderizando viagens:', viagens);
    
    if (!viagens || !Array.isArray(viagens)) {
        console.error('Dados de viagens inv√°lidos:', viagens);
        viagens = [];
    }

    const pendentes = viagens.filter(v => v.status === 'pendente' || v.status === 'Pendente');
    const emAndamento = viagens.filter(v => v.status === 'em_andamento' || v.status === 'Em Andamento');
    const concluidas = viagens.filter(v => v.status === 'concluida' || v.status === 'Conclu√≠da');

    console.log(`üìä Estat√≠sticas: ${pendentes.length} pendentes, ${emAndamento.length} em andamento, ${concluidas.length} conclu√≠das`);

    renderizarListaViagens('viagens-pendentes-list', pendentes, 'pendente');
    renderizarListaViagens('viagens-concluidas-list', concluidas, 'concluida');
    
    // Para viagens em andamento, vamos mostrar em uma lista separada
    // mas sem os bot√µes de a√ß√£o do admin
    const listaAndamento = document.getElementById('viagens-andamento-list');
    if (listaAndamento) {
        if (emAndamento.length === 0) {
            listaAndamento.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üöó</div>
                    <div>Nenhuma viagem em andamento</div>
                    <div style="font-size: 12px; margin-top: 5px;">As viagens em andamento s√£o gerenciadas pelos motoristas</div>
                </div>
            `;
        } else {
            listaAndamento.innerHTML = emAndamento.map(viagem => {
                const idViagem = viagem.id_viagem || viagem.id;
                const nomeCliente = viagem.nome_cliente || viagem.cliente_nome || viagem.nome_cliente || 'Cliente';
                const origem = viagem.origem || 'Origem n√£o informada';
                const destino = viagem.destino || 'Destino n√£o informado';
                const dataViagem = viagem.data_viagem || viagem.data;
                const valor = viagem.valor || 0;
                const veiculo = viagem.veiculo_solicitado || viagem.veiculo;
                const passageiros = viagem.passageiros || 1;
                const observacoes = viagem.observacoes;
                const motorista = viagem.nome_motorista || viagem.motorista_nome;
                const status = viagem.status;

                return `
                    <div class="data-item">
                        <div class="item-info">
                            <div class="item-name">
                                ${nomeCliente} - Viagem #${idViagem}
                            </div>
                            <div class="item-details">
                                <strong>${origem}</strong> ‚Üí <strong>${destino}</strong>
                            </div>
                            <div class="item-details">
                                ${formatarData(dataViagem)} ‚Ä¢ R$ ${parseFloat(valor).toFixed(2)}
                                ${veiculo ? ` ‚Ä¢ ${veiculo}` : ''}
                                ${passageiros > 1 ? ` ‚Ä¢ ${passageiros} passageiros` : ''}
                            </div>
                            ${observacoes ? `<div class="item-details"><em>${observacoes}</em></div>` : ''}
                            ${motorista ? `<div class="item-details">Motorista: ${motorista}</div>` : ''}
                        </div>
                        <div class="item-actions">
                            <button class="action-btn edit-btn" onclick="concluirViagem(${idViagem})">
                                ‚úÖ Concluir
                            </button>
                        </div>
                        <div class="item-status status-${normalizarStatus(status)}">
                            ${obterTextoStatus(status)}
                        </div>
                    </div>
                `;
            }).join('');
        }
    }
}

function renderizarListaViagens(elementId, viagens, tipo) {
    const lista = document.getElementById(elementId);
    
    if (!lista) {
        console.error(`Elemento ${elementId} n√£o encontrado`);
        return;
    }
    
    if (!viagens || viagens.length === 0) {
        lista.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üöó</div>
                <div>Nenhuma viagem ${obterTextoStatus(tipo).toLowerCase()}</div>
            </div>
        `;
        return;
    }

    lista.innerHTML = viagens.map(viagem => {
        const idViagem = viagem.id_viagem || viagem.id;
        const nomeCliente = viagem.nome_cliente || viagem.cliente_nome || viagem.nome_cliente || 'Cliente';
        const origem = viagem.origem || 'Origem n√£o informada';
        const destino = viagem.destino || 'Destino n√£o informado';
        const dataViagem = viagem.data_viagem || viagem.data;
        const valor = viagem.valor || 0;
        const veiculo = viagem.veiculo_solicitado || viagem.veiculo;
        const passageiros = viagem.passageiros || 1;
        const observacoes = viagem.observacoes;
        const motorista = viagem.nome_motorista || viagem.motorista_nome;
        const status = viagem.status;

        return `
            <div class="data-item">
                <div class="item-info">
                    <div class="item-name">
                        ${nomeCliente} - Viagem #${idViagem}
                    </div>
                    <div class="item-details">
                        <strong>${origem}</strong> ‚Üí <strong>${destino}</strong>
                    </div>
                    <div class="item-details">
                        ${formatarData(dataViagem)} ‚Ä¢ R$ ${parseFloat(valor).toFixed(2)}
                        ${veiculo ? ` ‚Ä¢ ${veiculo}` : ''}
                        ${passageiros > 1 ? ` ‚Ä¢ ${passageiros} passageiros` : ''}
                    </div>
                    ${observacoes ? `<div class="item-details"><em>${observacoes}</em></div>` : ''}
                    ${motorista ? `<div class="item-details">Motorista: ${motorista}</div>` : ''}
                </div>
                <div class="item-actions">
                    ${gerarBotoesAcao(viagem)}
                </div>
                <div class="item-status status-${normalizarStatus(status)}">
                    ${obterTextoStatus(status)}
                </div>
            </div>
        `;
    }).join('');
}

function normalizarStatus(status) {
    if (!status) return 'pendente';
    
    const statusMap = {
        'pendente': 'pendente',
        'Pendente': 'pendente',
        'aceita': 'aceita', 
        'Aceita': 'aceita',
        'em_andamento': 'andamento',
        'Em Andamento': 'andamento',
        'concluida': 'concluida',
        'Conclu√≠da': 'concluida',
        'cancelada': 'cancelada',
        'Cancelada': 'cancelada',
        'recusada': 'cancelada',
        'Recusada': 'cancelada'
    };
    
    return statusMap[status] || 'pendente';
}

function gerarBotoesAcao(viagem) {
    const status = viagem.status;
    const idViagem = viagem.id_viagem || viagem.id;

    // Para todas as viagens, mostra apenas bot√£o de detalhes
    // Exceto para viagens em andamento que mostram "Concluir"
    if (status === 'em_andamento' || status === 'Em Andamento') {
        return `
            <button class="action-btn edit-btn" onclick="concluirViagem(${idViagem})">
                ‚úÖ Concluir
            </button>
        `;
    }
    
    // Para outras situa√ß√µes, mostra apenas detalhes
    return `
        <button class="action-btn edit-btn" onclick="detalhesViagem(${idViagem})">
            üëÅÔ∏è Detalhes
        </button>
    `;
}

// ========== A√á√ïES DE VIAGENS ==========
async function aceitarViagem(idViagem) {
    if (!confirm('Deseja aceitar esta viagem?')) return;
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/admin/viagens/${idViagem}/aceitar`, {
            method: 'PUT'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Viagem aceita com sucesso!');
            carregarViagens();
        } else {
            alert('‚ùå Erro ao aceitar viagem: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro de conex√£o ao aceitar viagem');
    }
}

async function recusarViagem(idViagem) {
    const motivo = prompt('Informe o motivo da recusa:');
    if (!motivo) return;
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/admin/viagens/${idViagem}/recusar`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ motivo })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Viagem recusada com sucesso!');
            carregarViagens();
        } else {
            alert('‚ùå Erro ao recusar viagem: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro de conex√£o ao recusar viagem');
    }
}

async function iniciarViagem(idViagem) {
    if (!confirm('Deseja iniciar esta viagem?')) return;
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/admin/viagens/${idViagem}/iniciar`, {
            method: 'PUT'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Viagem iniciada com sucesso!');
            carregarViagens();
        } else {
            alert('‚ùå Erro ao iniciar viagem: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro de conex√£o ao iniciar viagem');
    }
}

async function concluirViagem(idViagem) {
    if (!confirm('Deseja concluir esta viagem?')) return;
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/admin/viagens/${idViagem}/concluir`, {
            method: 'PUT'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Viagem conclu√≠da com sucesso!');
            carregarViagens();
        } else {
            alert('‚ùå Erro ao concluir viagem: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro de conex√£o ao concluir viagem');
    }
}

async function cancelarViagem(idViagem) {
    if (!confirm('Deseja cancelar esta viagem?')) return;
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/admin/viagens/${idViagem}/cancelar`, {
            method: 'PUT'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Viagem cancelada com sucesso!');
            carregarViagens();
        } else {
            alert('‚ùå Erro ao cancelar viagem: ' + (data.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro de conex√£o ao cancelar viagem');
    }
}

function detalhesViagem(idViagem) {
    const viagem = appState.viagens.find(v => (v.id_viagem === idViagem) || (v.id === idViagem));
    if (viagem) {
        const nomeCliente = viagem.nome_cliente || viagem.cliente_nome || 'N/A';
        const origem = viagem.origem || 'N/A';
        const destino = viagem.destino || 'N/A';
        const dataViagem = viagem.data_viagem || viagem.data;
        const valor = viagem.valor || 0;
        const observacoes = viagem.observacoes || 'Nenhuma';
        const status = viagem.status;

        alert(`Detalhes da Viagem #${idViagem}\n\n` +
              `Cliente: ${nomeCliente}\n` +
              `Origem: ${origem}\n` +
              `Destino: ${destino}\n` +
              `Data: ${formatarData(dataViagem)}\n` +
              `Valor: R$ ${parseFloat(valor).toFixed(2)}\n` +
              `Status: ${obterTextoStatus(status)}\n` +
              `Observa√ß√µes: ${observacoes}`);
    }
}

// ========== CRIA√á√ÉO DE VIAGENS ==========
async function criarViagem(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const dados = Object.fromEntries(formData);
    
    // Valida√ß√µes
    if (!dados.id_cliente) {
        alert('‚ùå Selecione um cliente!');
        return;
    }
    
    if (!dados.origem || !dados.destino) {
        alert('‚ùå Preencha origem e destino!');
        return;
    }
    
    if (!dados.data_viagem) {
        alert('‚ùå Selecione data e hora!');
        return;
    }
    
    // Converter tipos
    dados.valor = parseFloat(dados.valor) || 0;
    dados.passageiros = parseInt(dados.passageiros) || 1;
    
    if (!dados.id_motorista) delete dados.id_motorista;
    if (!dados.veiculo_solicitado) delete dados.veiculo_solicitado;
    if (!dados.observacoes) delete dados.observacoes;
    
    console.log('üì§ Criando viagem:', dados);
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/viagens`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Erro do servidor:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (resultado.success) {
            alert('‚úÖ Viagem criada com sucesso!');
            limparFormularioViagem();
            carregarViagens();
        } else {
            alert('‚ùå Erro ao criar viagem: ' + (resultado.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao criar viagem:', error);
        alert('‚ùå Erro de conex√£o ao criar viagem: ' + error.message);
    }
}

function limparFormularioViagem() {
    document.getElementById('formNovaViagem').reset();
    
    // Restaurar valores padr√£o
    const agora = new Date();
    agora.setHours(agora.getHours() + 1);
    document.getElementById('data_viagem').value = agora.toISOString().slice(0, 16);
    document.getElementById('passageiros_viagem').value = 1;
}

// ========== FUN√á√ïES DE VE√çCULOS (MODAIS) ==========
function abrirModalVeiculo() {
    console.log('üìù Abrindo modal de ve√≠culo...');
    document.getElementById('modalVeiculo').style.display = 'block';
    carregarOpcoesModal();
}

function fecharModalVeiculo() {
    document.getElementById('modalVeiculo').style.display = 'none';
    document.getElementById('formVeiculo').reset();
}

function abrirModalEditarVeiculo() {
    document.getElementById('modalEditarVeiculo').style.display = 'block';
}

function fecharModalEditarVeiculo() {
    document.getElementById('modalEditarVeiculo').style.display = 'none';
    document.getElementById('formEditarVeiculo').reset();
}

async function carregarOpcoesModal() {
    try {
        // Carregar categorias para o modal
        const responseCategorias = await fetch(`${CONFIG.API_BASE_URL}/categorias`);
        if (responseCategorias.ok) {
            const data = await responseCategorias.json();
            const selectCategoria = document.getElementById('id_categoria');
            if (data.success && data.categorias) {
                selectCategoria.innerHTML = '<option value="">Selecione uma categoria</option>' +
                    data.categorias.map(cat => 
                        `<option value="${cat.id_categoria}">${cat.nome}</option>`
                    ).join('');
            }
        }
        
        // Carregar filiais para o modal
        const responseFiliais = await fetch(`${CONFIG.API_BASE_URL}/filiais`);
        if (responseFiliais.ok) {
            const data = await responseFiliais.json();
            const selectFilial = document.getElementById('id_filial');
            if (data.success && data.filiais) {
                selectFilial.innerHTML = '<option value="">Selecione uma filial</option>' +
                    data.filiais.map(filial => 
                        `<option value="${filial.id_filial}">${filial.nome}</option>`
                    ).join('');
            }
        }
    } catch (error) {
        console.error('Erro ao carregar op√ß√µes do modal:', error);
    }
}

async function cadastrarVeiculo(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const dados = Object.fromEntries(formData);
    
    // Converter para n√∫meros
    dados.ano = parseInt(dados.ano);
    dados.quilometragem = parseFloat(dados.quilometragem);
    dados.id_categoria = parseInt(dados.id_categoria);
    dados.id_filial = parseInt(dados.id_filial);
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/veiculos`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (resultado.success) {
            alert('‚úÖ Ve√≠culo cadastrado com sucesso!');
            fecharModalVeiculo();
            carregarVeiculos();
            carregarEstatisticas();
        } else {
            alert('‚ùå Erro ao cadastrar ve√≠culo: ' + (resultado.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao cadastrar ve√≠culo:', error);
        alert('‚ùå Erro de conex√£o ao cadastrar ve√≠culo');
    }
}

async function editarVeiculo(idVeiculo) {
    console.log('‚úèÔ∏è Editando ve√≠culo:', idVeiculo);
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/veiculo/${idVeiculo}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            const veiculo = data.veiculo;
            
            // Preencher formul√°rio
            document.getElementById('editar_id_veiculo').value = veiculo.id_veiculo;
            document.getElementById('editar_placa').value = veiculo.placa;
            document.getElementById('editar_modelo').value = veiculo.modelo;
            document.getElementById('editar_ano').value = veiculo.ano;
            document.getElementById('editar_cor').value = veiculo.cor;
            document.getElementById('editar_quilometragem').value = veiculo.quilometragem;
            document.getElementById('editar_status').value = veiculo.status;
            
            // Carregar op√ß√µes dos selects
            await carregarOpcoesModalEdicao();
            
            document.getElementById('editar_id_categoria').value = veiculo.id_categoria;
            document.getElementById('editar_id_filial').value = veiculo.id_filial;
            
            // Abrir modal
            document.getElementById('modalEditarVeiculo').style.display = 'block';
        } else {
            alert('‚ùå Erro ao carregar dados do ve√≠culo');
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao carregar dados do ve√≠culo');
    }
}

async function carregarOpcoesModalEdicao() {
    try {
        // Carregar categorias
        const responseCategorias = await fetch(`${CONFIG.API_BASE_URL}/categorias`);
        if (responseCategorias.ok) {
            const data = await responseCategorias.json();
            const selectCategoria = document.getElementById('editar_id_categoria');
            if (data.success && data.categorias) {
                selectCategoria.innerHTML = data.categorias.map(cat => 
                    `<option value="${cat.id_categoria}">${cat.nome}</option>`
                ).join('');
            }
        }
        
        // Carregar filiais
        const responseFiliais = await fetch(`${CONFIG.API_BASE_URL}/filiais`);
        if (responseFiliais.ok) {
            const data = await responseFiliais.json();
            const selectFilial = document.getElementById('editar_id_filial');
            if (data.success && data.filiais) {
                selectFilial.innerHTML = data.filiais.map(filial => 
                    `<option value="${filial.id_filial}">${filial.nome}</option>`
                ).join('');
            }
        }
    } catch (error) {
        console.error('Erro ao carregar op√ß√µes do modal:', error);
    }
}

async function editarVeiculoSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const dados = Object.fromEntries(formData);
    
    // Converter para tipos apropriados
    dados.ano = parseInt(dados.ano);
    dados.quilometragem = parseFloat(dados.quilometragem);
    dados.id_categoria = parseInt(dados.id_categoria);
    dados.id_filial = parseInt(dados.id_filial);
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/veiculos/${dados.id_veiculo}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (resultado.success) {
            alert('‚úÖ Ve√≠culo atualizado com sucesso!');
            fecharModalEditarVeiculo();
            carregarVeiculos();
        } else {
            alert('‚ùå Erro ao atualizar ve√≠culo: ' + (resultado.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro ao atualizar ve√≠culo:', error);
        alert('‚ùå Erro de conex√£o ao atualizar ve√≠culo');
    }
}

async function excluirVeiculo(idVeiculo, placa) {
    if (!confirm(`Tem certeza que deseja excluir o ve√≠culo ${placa}?`)) return;
    
    try {
        const response = await fetch(`${CONFIG.API_BASE_URL}/veiculos/${idVeiculo}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const resultado = await response.json();
        
        if (resultado.success) {
            alert('‚úÖ Ve√≠culo exclu√≠do com sucesso!');
            carregarVeiculos();
            carregarEstatisticas();
        } else {
            alert('‚ùå Erro ao excluir ve√≠culo: ' + (resultado.error || 'Erro desconhecido'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro de conex√£o ao excluir ve√≠culo');
    }
}

// ========== FUN√á√ïES UTILIT√ÅRIAS ==========
function formatarData(dataString) {
    if (!dataString) return 'Data n√£o informada';
    try {
        const data = new Date(dataString);
        return data.toLocaleString('pt-BR');
    } catch (error) {
        return dataString;
    }
}

function obterTextoStatus(status) {
    if (!status) return 'Pendente';
    
    const statusMap = {
        'pendente': 'Pendente',
        'Pendente': 'Pendente',
        'aceita': 'Aceita',
        'Aceita': 'Aceita', 
        'em_andamento': 'Em Andamento',
        'Em Andamento': 'Em Andamento',
        'concluida': 'Conclu√≠da',
        'Conclu√≠da': 'Conclu√≠da',
        'cancelada': 'Cancelada',
        'Cancelada': 'Cancelada',
        'recusada': 'Recusada',
        'Recusada': 'Recusada'
    };
    return statusMap[status] || status;
}

function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        nome: params.get('nome') || 'Administrador',
        cargo: params.get('cargo') || 'administrador'
    };
}

function atualizarInterface() {
    const params = getUrlParams();
    document.getElementById('user-name').textContent = params.nome;
    document.getElementById('user-role').textContent = params.cargo.charAt(0).toUpperCase() + params.cargo.slice(1);
}

function exportarRelatorioViagens() {
    alert('üìä Funcionalidade de exporta√ß√£o em desenvolvimento...');
}

function mostrarErroCarregamento() {
    const elementos = [
        'veiculos-list', 'funcionarios-list', 'filiais-list', 'categorias-list',
        'viagens-pendentes-list', 'viagens-andamento-list', 'viagens-concluidas-list'
    ];
    
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <div>Erro ao carregar dados</div>
                    <div style="font-size: 12px; margin-top: 5px;">Verifique a conex√£o com o servidor</div>
                </div>
            `;
        }
    });
}

function mostrarErroViagensEspecifico() {
    const elementos = ['viagens-pendentes-list', 'viagens-andamento-list', 'viagens-concluidas-list'];
    
    elementos.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <div>Endpoints de Viagens N√£o Encontrados</div>
                    <div style="font-size: 12px; margin-top: 5px;">
                        Verifique se os endpoints est√£o configurados no app.py
                    </div>
                    <button class="btn btn-primary" onclick="testarEndpointsManualmente()" style="margin-top: 10px;">
                        üîÑ Testar Endpoints
                    </button>
                </div>
            `;
        }
    });
}

// Fun√ß√£o para testar endpoints manualmente
async function testarEndpointsManualmente() {
    console.log('üß™ Testando endpoints manualmente...');
    
    const endpoints = [
        '/viagens',
        '/admin/viagens', 
        '/viagens/todas',
        '/clientes',
        '/motoristas'
    ];
    
    for (const endpoint of endpoints) {
        try {
            const response = await fetch(`${CONFIG.API_BASE_URL}${endpoint}`);
            console.log(`${endpoint}: ${response.status} ${response.statusText}`);
        } catch (error) {
            console.log(`${endpoint}: ERRO - ${error.message}`);
        }
    }
    
    alert('Verifique o console para ver os resultados dos testes');
}
</script>


</body>
</html>